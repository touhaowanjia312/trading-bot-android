name: ğŸ¤– ä¿®å¤ç‰ˆAndroidæ„å»º

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'  # æ”¹ä¸ºJava 11ï¼Œæ›´ç¨³å®š
        
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          build-essential \
          git \
          python3-dev \
          python3-pip \
          python3-setuptools \
          python3-wheel \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          zlib1g-dev \
          unzip \
          wget \
          curl \
          autoconf \
          libtool \
          pkg-config
          
    - name: ğŸ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        pip install buildozer==1.4.0  # å›ºå®šç‰ˆæœ¬
        pip install cython==0.29.33   # å›ºå®šç‰ˆæœ¬
        pip install kivy==2.1.0
        
    - name: ğŸ“± æ‰‹åŠ¨è®¾ç½®Android SDK (ä¿®å¤ç‰ˆ)
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3
        
        # åˆ›å»ºç›®å½•
        mkdir -p $ANDROID_HOME/cmdline-tools
        
        # ä¸‹è½½å‘½ä»¤è¡Œå·¥å…·
        cd $ANDROID_HOME/cmdline-tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
        unzip -q commandlinetools-linux-8512546_latest.zip
        mv cmdline-tools latest
        
        # æ¥å—è®¸å¯è¯
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        # å®‰è£…å¿…è¦ç»„ä»¶ (ä½¿ç”¨ç¨³å®šç‰ˆæœ¬)
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-30" \
          "build-tools;30.0.3" \
          "ndk;21.4.7075529"
        
        # éªŒè¯å®‰è£…
        ls -la $ANDROID_HOME/
        ls -la $ANDROID_HOME/build-tools/
        
        # ä¿å­˜ç¯å¢ƒå˜é‡åˆ°åç»­æ­¥éª¤
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
        echo "PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3" >> $GITHUB_ENV
        
    - name: ğŸ“ åˆ›å»ºä¼˜åŒ–çš„åº”ç”¨æ–‡ä»¶
      run: |
        # åˆ›å»ºç®€å•çš„main.py
        cat > main.py << 'EOF'
        #!/usr/bin/env python3
        from kivy.app import App
        from kivy.uix.label import Label
        
        class TradingApp(App):
            def build(self):
                return Label(text='ğŸ“± äº¤æ˜“æœºå™¨äºº\næ„å»ºæˆåŠŸï¼', 
                           font_size=20, 
                           halign='center')
        
        if __name__ == '__main__':
            TradingApp().run()
        EOF
        
        # åˆ›å»ºä¼˜åŒ–çš„buildozer.spec
        cat > buildozer.spec << 'EOF'
        [app]
        title = TradingBot
        package.name = tradingbot
        package.domain = com.example.tradingbot
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        requirements = python3,kivy
        
        [buildozer]
        log_level = 2
        warn_on_root = 0
        
        [app:android]
        android.api = 30
        android.minapi = 21
        android.ndk = 21.4.7075529
        android.sdk = 30
        android.accept_sdk_license = True
        android.gradle_dependencies = 
        android.add_compile_options = 
        android.add_gradle_repositories = 
        android.add_packaging_options = 
        EOF
        
    - name: ğŸ—ï¸ æ„å»ºAndroid APK (ä¿®å¤ç‰ˆ)
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºAPK..."
        
        # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "Javaç‰ˆæœ¬:"
        java -version
        echo "Pythonç‰ˆæœ¬:"
        python --version
        
        # æ¸…ç†å¯èƒ½çš„ç¼“å­˜
        rm -rf .buildozer
        
        # æ„å»ºAPK
        buildozer android debug --verbose 2>&1 | tee build.log || {
          echo "âŒ æ„å»ºå¤±è´¥ï¼Œæ˜¾ç¤ºæœ€å50è¡Œæ—¥å¿—ï¼š"
          tail -50 build.log
          echo "âŒ æ˜¾ç¤ºé”™è¯¯ç›¸å…³æ—¥å¿—ï¼š"
          grep -i "error\|fail\|exception" build.log | tail -20 || echo "æœªæ‰¾åˆ°æ˜ç¡®é”™è¯¯ä¿¡æ¯"
          exit 1
        }
        
    - name: ğŸ“‹ æ˜¾ç¤ºæ„å»ºç»“æœ
      run: |
        echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
        echo "æŸ¥æ‰¾APKæ–‡ä»¶:"
        find . -name "*.apk" -type f -exec ls -lh {} \; || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
        
        echo "æŸ¥æ‰¾æ„å»ºç›®å½•:"
        ls -la bin/ 2>/dev/null || echo "binç›®å½•ä¸å­˜åœ¨"
        ls -la .buildozer/android/platform/build-*/build/outputs/apk/ 2>/dev/null || echo "æ ‡å‡†APKè¾“å‡ºç›®å½•ä¸å­˜åœ¨"
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-build-artifacts
        path: |
          bin/*.apk
          .buildozer/android/platform/build-*/build/outputs/apk/**/*.apk
          build.log
        retention-days: 30