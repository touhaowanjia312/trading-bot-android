name: ðŸš€ è¶…ç¨³å®šAndroidæž„å»º

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• è®¾ç½®JavaçŽ¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          python3-dev \
          python3-pip \
          python3-setuptools \
          python3-wheel \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          zlib1g-dev \
          libfreetype6-dev \
          liblcms2-dev \
          libopenjp2-7-dev \
          libtiff5-dev \
          libwebp-dev \
          tcl8.6-dev \
          tk8.6-dev \
          python3-tk \
          libharfbuzz-dev \
          libfribidi-dev \
          libxcb1-dev \
          unzip \
          wget \
          curl
          
    - name: ðŸ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        pip install buildozer cython
        pip install kivy==2.1.0
        
    - name: ðŸ“± ä½¿ç”¨é¢„é…ç½®Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 30
        build-tools: 30.0.3
        ndk-version: 23.2.8568313
        
    - name: ðŸ”§ éªŒè¯AndroidçŽ¯å¢ƒ
      run: |
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        ls -la $ANDROID_HOME/ || echo "Androidç›®å½•ä¸å­˜åœ¨"
        which adb || echo "adbæœªæ‰¾åˆ°"
        
    - name: ðŸ“ åˆ›å»ºå¿…è¦æ–‡ä»¶
      run: |
        # åˆ›å»ºç®€å•çš„Kivyåº”ç”¨
        cat > simple_mobile_app.py << 'EOF'
        #!/usr/bin/env python3
        # -*- coding: utf-8 -*-
        """
        ç®€å•çš„ç§»åŠ¨ç«¯äº¤æ˜“æœºå™¨äººåº”ç”¨
        """
        
        try:
            from kivy.app import App
            from kivy.uix.boxlayout import BoxLayout
            from kivy.uix.label import Label
            from kivy.uix.button import Button
            from kivy.clock import Clock
            KIVY_AVAILABLE = True
        except ImportError:
            print("âš ï¸ Kivyæœªå®‰è£…ï¼Œå°†ä½¿ç”¨æŽ§åˆ¶å°æ¨¡å¼")
            KIVY_AVAILABLE = False
            
            # åˆ›å»ºå ä½ç¬¦ç±»
            class BoxLayout:
                def __init__(self, **kwargs):
                    pass
                def add_widget(self, widget):
                    pass
                    
            class Label:
                def __init__(self, **kwargs):
                    self.text = kwargs.get('text', '')
                    
            class Button:
                def __init__(self, **kwargs):
                    self.text = kwargs.get('text', '')
                    
            class Clock:
                @staticmethod
                def schedule_interval(func, interval):
                    pass
                    
            class App:
                def build(self):
                    return None
                def run(self):
                    print("ðŸ–¥ï¸ æŽ§åˆ¶å°æ¨¡å¼è¿è¡Œ")
        
        import asyncio
        import threading
        import time
        from datetime import datetime
        
        class SimpleTradingApp(App):
            def __init__(self, **kwargs):
                super().__init__(**kwargs)
                self.title = "ðŸ“± ç§»åŠ¨äº¤æ˜“æœºå™¨äºº"
                self.status = "ðŸ”´ æœªè¿žæŽ¥"
                self.is_running = False
                
            def build(self):
                if not KIVY_AVAILABLE:
                    print("ðŸ“± ç§»åŠ¨äº¤æ˜“æœºå™¨äºº - æŽ§åˆ¶å°æ¨¡å¼")
                    return None
                    
                # ä¸»å¸ƒå±€
                main_layout = BoxLayout(orientation='vertical', padding=10, spacing=10)
                
                # çŠ¶æ€æ˜¾ç¤º
                self.status_label = Label(
                    text=f"çŠ¶æ€: {self.status}",
                    size_hint_y=None,
                    height=50
                )
                main_layout.add_widget(self.status_label)
                
                # æŽ§åˆ¶æŒ‰é’®
                btn_layout = BoxLayout(orientation='horizontal', size_hint_y=None, height=50)
                
                start_btn = Button(text="ðŸš€ å¯åŠ¨")
                start_btn.bind(on_press=self.start_bot)
                btn_layout.add_widget(start_btn)
                
                stop_btn = Button(text="â¹ï¸ åœæ­¢")
                stop_btn.bind(on_press=self.stop_bot)
                btn_layout.add_widget(stop_btn)
                
                main_layout.add_widget(btn_layout)
                
                # æ—¥å¿—æ˜¾ç¤º
                self.log_label = Label(
                    text="ðŸ“‹ ç­‰å¾…å¯åŠ¨...",
                    text_size=(None, None),
                    valign='top'
                )
                main_layout.add_widget(self.log_label)
                
                # å®šæ—¶æ›´æ–°çŠ¶æ€
                Clock.schedule_interval(self.update_status, 1.0)
                
                return main_layout
                
            def start_bot(self, instance):
                self.is_running = True
                self.status = "ðŸŸ¢ è¿è¡Œä¸­"
                self.log("ðŸš€ äº¤æ˜“æœºå™¨äººå·²å¯åŠ¨")
                
            def stop_bot(self, instance):
                self.is_running = False
                self.status = "ðŸ”´ å·²åœæ­¢"
                self.log("â¹ï¸ äº¤æ˜“æœºå™¨äººå·²åœæ­¢")
                
            def update_status(self, dt):
                if hasattr(self, 'status_label'):
                    self.status_label.text = f"çŠ¶æ€: {self.status} | æ—¶é—´: {datetime.now().strftime('%H:%M:%S')}"
                    
            def log(self, message):
                timestamp = datetime.now().strftime('%H:%M:%S')
                log_message = f"[{timestamp}] {message}"
                print(log_message)
                
                if hasattr(self, 'log_label'):
                    current_text = self.log_label.text
                    lines = current_text.split('\n')
                    if len(lines) > 10:  # ä¿æŒæœ€æ–°10è¡Œ
                        lines = lines[-9:]
                    lines.append(log_message)
                    self.log_label.text = '\n'.join(lines)
        
        if __name__ == '__main__':
            app = SimpleTradingApp()
            if KIVY_AVAILABLE:
                app.run()
            else:
                print("ðŸ“± ç®€å•äº¤æ˜“åº”ç”¨ - æŽ§åˆ¶å°ç‰ˆæœ¬")
                print("âœ… åº”ç”¨åˆ›å»ºæˆåŠŸ")
                print("ðŸŽ¯ è¿™æ˜¯ä¸€ä¸ªç”¨äºŽAndroidæž„å»ºæµ‹è¯•çš„ç®€åŒ–ç‰ˆæœ¬")
        EOF
        
        # åˆ›å»ºbuildozeré…ç½®
        cat > buildozer.spec << 'EOF'
        [app]
        title = äº¤æ˜“æœºå™¨äºº
        package.name = tradingbot
        package.domain = com.tradingbot.app
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas,txt,json
        version = 1.0
        requirements = python3,kivy==2.1.0
        [buildozer]
        log_level = 2
        warn_on_root = 0
        EOF
        
    - name: ðŸ—ï¸ æž„å»ºAndroid APK
      run: |
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        
        echo "ðŸ”¨ å¼€å§‹æž„å»ºAPK..."
        buildozer android debug --verbose || {
          echo "âŒ æž„å»ºå¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—..."
          cat .buildozer/android/platform/build-*/build.log || echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        }
        
    - name: ðŸ“‹ æ˜¾ç¤ºæž„å»ºç»“æžœ
      run: |
        echo "ðŸŽ‰ æž„å»ºå®Œæˆï¼"
        ls -la bin/ || echo "binç›®å½•ä¸å­˜åœ¨"
        find . -name "*.apk" -type f || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
        
    - name: ðŸ“¤ ä¸Šä¼ APKæ–‡ä»¶
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-apk
        path: |
          bin/*.apk
          .buildozer/android/platform/build-*/build.log
        retention-days: 30
