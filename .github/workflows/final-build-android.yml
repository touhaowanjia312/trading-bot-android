name: ðŸ¤– å®˜æ–¹SDKç‰ˆAndroidæž„å»º

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• è®¾ç½®JavaçŽ¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'  # å‡çº§åˆ°Java 17ä»¥å…¼å®¹æœ€æ–°çš„Android SDKå·¥å…·
        
    - name: ðŸ“± ä½¿ç”¨å®˜æ–¹Android Setup Action
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 8512546
        accept-android-sdk-licenses: true
        packages: "platform-tools platforms;android-30 build-tools;30.0.3 ndk;21.4.7075529"
        
    - name: ðŸ”§ éªŒè¯AndroidçŽ¯å¢ƒ
      run: |
        echo "=== AndroidçŽ¯å¢ƒéªŒè¯ ==="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        
        echo "=== SDKç›®å½•ç»“æž„ ==="
        ls -la $ANDROID_HOME/ || echo "ANDROID_HOMEç›®å½•ä¸å­˜åœ¨"
        
        echo "=== Build Toolsæ£€æŸ¥ ==="
        ls -la $ANDROID_HOME/build-tools/ || echo "build-toolsç›®å½•ä¸å­˜åœ¨"
        
        echo "=== æ£€æŸ¥aidlå·¥å…· ==="
        find $ANDROID_HOME -name "aidl" -type f 2>/dev/null | head -5
        
        echo "=== çŽ¯å¢ƒå˜é‡ ==="
        env | grep ANDROID
        
    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update -qq
        
        # å¯ç”¨32ä½æž¶æž„æ”¯æŒ
        sudo dpkg --add-architecture i386
        sudo apt-get update -qq
        
        # å®‰è£…ä¸»è¦ä¾èµ–
        sudo apt-get install -y \
          build-essential \
          git \
          python3-dev \
          python3-pip \
          python3-setuptools \
          python3-wheel \
          libffi-dev \
          libssl-dev \
          libjpeg-dev \
          zlib1g-dev \
          unzip \
          autoconf \
          libtool \
          libtool-bin \
          automake \
          pkg-config \
          cmake \
          ninja-build \
          ccache \
          wget \
          curl
        
        # å°è¯•å®‰è£…32ä½åº“ï¼ˆUbuntu 24.04å…¼å®¹ï¼‰
        sudo apt-get install -y \
          libc6:i386 \
          libstdc++6:i386 \
          zlib1g:i386 || echo "âš ï¸ æŸäº›32ä½åº“å®‰è£…å¤±è´¥ï¼Œä½†å¯èƒ½ä¸å½±å“æž„å»º"
          
    - name: ðŸ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools
        pip install buildozer==1.4.0
        pip install cython==0.29.33
        pip install kivy==2.1.0
        
    - name: ðŸ“ åˆ›å»ºåº”ç”¨æ–‡ä»¶
      run: |
        cat > main.py << 'EOF'
        #!/usr/bin/env python3
        from kivy.app import App
        from kivy.uix.label import Label
        
        class TradingApp(App):
            def build(self):
                return Label(text='ðŸ“± äº¤æ˜“æœºå™¨äºº\næž„å»ºæˆåŠŸï¼', 
                           font_size=20, 
                           halign='center')
        
        if __name__ == '__main__':
            TradingApp().run()
        EOF
        
        cat > buildozer.spec << 'EOF'
        [app]
        title = TradingBot
        package.name = tradingbot
        package.domain = com.example.tradingbot
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        source.main = main.py
        version = 1.0
        requirements = python3,kivy
        
        [buildozer]
        log_level = 2
        warn_on_root = 0
        
        [app:android]
        android.api = 30
        android.minapi = 21
        android.ndk = 21.4.7075529
        android.sdk = 30
        android.accept_sdk_license = True
        android.arch = arm64-v8a
        android.gradle_dependencies = 
        android.add_compile_options = 
        android.add_gradle_repositories = 
        android.add_packaging_options = 
        EOF
        
    - name: ðŸ”§ ä¿®å¤buildozer Androidè·¯å¾„
      run: |
        echo "=== ä¿®å¤buildozerçš„Android SDKè·¯å¾„ ==="
        
        # ç¡®ä¿buildozerèƒ½æ‰¾åˆ°Android SDK
        mkdir -p ~/.buildozer/android/platform
        
        # åˆ›å»ºç¬¦å·é“¾æŽ¥æŒ‡å‘æ­£ç¡®çš„SDKä½ç½®
        if [ -d "$ANDROID_HOME" ]; then
          ln -sf "$ANDROID_HOME" ~/.buildozer/android/platform/android-sdk
          echo "âœ… åˆ›å»ºSDKç¬¦å·é“¾æŽ¥: $ANDROID_HOME -> ~/.buildozer/android/platform/android-sdk"
          
          # åˆ›å»ºtoolsç›®å½•å’Œsdkmanagerçš„ç¬¦å·é“¾æŽ¥ï¼ˆå…¼å®¹æ—§ç‰ˆbuildozerï¼‰
          mkdir -p ~/.buildozer/android/platform/android-sdk/tools/bin
          ln -sf "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
          echo "âœ… åˆ›å»ºsdkmanagerç¬¦å·é“¾æŽ¥ä»¥å…¼å®¹æ—§ç‰ˆbuildozer"
        fi
        
        # ç¡®ä¿PATHåŒ…å«æ‰€æœ‰å¿…è¦çš„å·¥å…·
        export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3:$PATH"
        
        echo "=== æœ€ç»ˆçŽ¯å¢ƒæ£€æŸ¥ ==="
        which aidl || echo "âš ï¸ aidlä»æœªåœ¨PATHä¸­"
        find $ANDROID_HOME -name "aidl" -type f | head -1 | xargs ls -la || echo "âŒ æ‰¾ä¸åˆ°aidlæ–‡ä»¶"
        
        echo "=== éªŒè¯sdkmanageré“¾æŽ¥ ==="
        ls -la ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager || echo "sdkmanageré“¾æŽ¥ä¸å­˜åœ¨"
        
    - name: ðŸ—ï¸ æž„å»ºAndroid APK
      run: |
        echo "ðŸ”¨ å¼€å§‹æž„å»ºAPK..."
        
        echo "=== æœ€ç»ˆçŽ¯å¢ƒä¿¡æ¯ ==="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        java -version
        python --version
        
        # ç¡®ä¿PATHæ­£ç¡®
        export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3:$PATH"
        
        echo "=== PATHæ£€æŸ¥ ==="
        echo $PATH | tr ':' '\n' | grep android || echo "PATHä¸­æ²¡æœ‰androidç›¸å…³è·¯å¾„"
        
        # æ˜¾ç¤ºbuildozeré…ç½®
        echo "=== Buildozeré…ç½® ==="
        cat buildozer.spec
        
        rm -rf .buildozer
        
        # æž„å»ºAPK - ä½¿ç”¨æ›´è¯¦ç»†çš„æ—¥å¿—
        echo "ðŸš€ å¼€å§‹buildozeræž„å»º..."
        buildozer android debug --verbose 2>&1 | tee build_complete.log || {
          echo "âŒ æž„å»ºå¤±è´¥ï¼"
          echo "=== æœ€åŽ200è¡Œæž„å»ºæ—¥å¿— ==="
          tail -200 build_complete.log
          echo ""
          echo "=== æœç´¢å…³é”®é”™è¯¯ ==="
          grep -i "error\|fail\|exception\|traceback" build_complete.log | tail -30 || echo "æœªæ‰¾åˆ°å…³é”®é”™è¯¯ä¿¡æ¯"
          echo ""
          echo "=== Python-for-Androidç›¸å…³é”™è¯¯ ==="
          grep -i "pythonforandroid\|p4a" build_complete.log | tail -20 || echo "æœªæ‰¾åˆ°p4aç›¸å…³é”™è¯¯"
          exit 1
        }
        
        echo "âœ… æž„å»ºå‘½ä»¤æ‰§è¡Œå®Œæˆ"
        
    - name: ðŸ” è¶…çº§è¯¦ç»†APKæœç´¢
      run: |
        echo "ðŸ” å¼€å§‹è¶…çº§è¯¦ç»†APKæœç´¢..."
        
        echo "=== æ ¹ç›®å½•æœç´¢ ==="
        find . -maxdepth 3 -name "*.apk" -type f 2>/dev/null | while read apk; do
          echo "ðŸ“± æ ¹ç›®å½•æ‰¾åˆ°APK: $apk"
          ls -lh "$apk"
          file "$apk"
        done
        
        echo "=== æ·±åº¦æœç´¢æ‰€æœ‰APK ==="
        find . -name "*.apk" -type f 2>/dev/null | head -20 | while read apk; do
          echo "ðŸ“± æ·±åº¦æœç´¢æ‰¾åˆ°APK: $apk"
          ls -lh "$apk"
        done
        
        echo "=== æ£€æŸ¥æ ‡å‡†è¾“å‡ºç›®å½• ==="
        for dir in "bin" ".buildozer/android/platform/build-*/build/outputs/apk" ".buildozer/android/platform/build-*/dist"; do
          if [ -d "$dir" ] 2>/dev/null; then
            echo "æ£€æŸ¥ç›®å½•: $dir"
            find "$dir" -name "*.apk" -type f 2>/dev/null | head -5
          fi
        done
        
        echo "=== æ£€æŸ¥buildozeråˆ†å‘ç›®å½• ==="
        find .buildozer -path "*/dist/*" -name "*.apk" -type f 2>/dev/null | head -10
        
        echo "=== æ£€æŸ¥gradleè¾“å‡º ==="
        find .buildozer -path "*/outputs/apk*" -type d 2>/dev/null | while read dir; do
          echo "Gradleè¾“å‡ºç›®å½•: $dir"
          ls -la "$dir/" 2>/dev/null | head -10
        done
        
    - name: ðŸ“¤ ä¸Šä¼ è¶…çº§å®Œæ•´æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: super-complete-android-build
        path: |
          **/*.apk
          bin/
          dist/
          .buildozer/android/platform/build-*/build/outputs/
          .buildozer/android/platform/build-*/dist/
          build_complete.log
        retention-days: 30
        
    - name: ðŸ“‹ æœ€ç»ˆæž„å»ºæŠ¥å‘Š
      if: always()
      run: |
        echo "ðŸ“Š æœ€ç»ˆæž„å»ºæŠ¥å‘Š"
        echo "=================="
        
        total_apks=$(find . -name "*.apk" -type f 2>/dev/null | wc -l)
        echo "ðŸŽ¯ æ€»å…±æ‰¾åˆ°APKæ–‡ä»¶: $total_apks ä¸ª"
        
        if [ $total_apks -gt 0 ]; then
          echo "âœ… ðŸŽ‰ APKæž„å»ºæˆåŠŸï¼"
          echo "=== APKæ–‡ä»¶åˆ—è¡¨ ==="
          find . -name "*.apk" -type f -exec ls -lh {} \; | head -10
          
          echo "=== æœ€å¤§çš„APKæ–‡ä»¶ ==="
          find . -name "*.apk" -type f -exec ls -lh {} \; | sort -k5 -hr | head -3
        else
          echo "âŒ ä»ç„¶æœªæ‰¾åˆ°APKæ–‡ä»¶"
          echo ""
          echo "ðŸ” å¯èƒ½çš„åŽŸå› å’Œè°ƒè¯•ä¿¡æ¯ï¼š"
          echo "1. æ£€æŸ¥ä¸Šä¼ çš„ build_complete.log æ–‡ä»¶"
          echo "2. æž„å»ºå¯èƒ½åœ¨æŸä¸ªéšè—æ­¥éª¤å¤±è´¥äº†"
          echo "3. APKå¯èƒ½ç”Ÿæˆåœ¨äº†éžæ ‡å‡†ä½ç½®"
          echo ""
          echo "=== buildozerç›®å½•ç»“æž„ ==="
          find .buildozer -type d -name "*apk*" 2>/dev/null | head -10 || echo "æ²¡æœ‰apkç›¸å…³ç›®å½•"
        fi
