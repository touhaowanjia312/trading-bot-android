name: ğŸ¤– æ„å»ºAndroidåº”ç”¨

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• è®¾ç½®Javaç¯å¢ƒ
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '8'
        
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip \
          build-essential libsdl2-dev libsdl2-image-dev \
          libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev \
          libswscale-dev libavformat-dev libavcodec-dev \
          zlib1g-dev autoconf libtool pkg-config \
          libffi-dev libssl-dev
          
    - name: ğŸ å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython
        pip install "kivy[base]==2.1.0"
        
    - name: ğŸ“± è®¾ç½®Android SDK
      run: |
        # è®¾ç½®Android SDKè·¯å¾„
        export ANDROID_HOME=$HOME/Android/Sdk
        mkdir -p $ANDROID_HOME
        
        # ä¸‹è½½Android SDKå‘½ä»¤è¡Œå·¥å…·
        cd $ANDROID_HOME
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mv cmdline-tools latest
        mkdir cmdline-tools
        mv latest cmdline-tools/
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        
        # å®‰è£…SDKç»„ä»¶
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-33"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.0"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;25.2.9519653"
        
    - name: ğŸ”§ éªŒè¯buildozeré…ç½®
      run: |
        # æ£€æŸ¥buildozer.specæ˜¯å¦å­˜åœ¨
        if [ ! -f buildozer.spec ]; then
          echo "åˆ›å»ºbuildozer.specé…ç½®æ–‡ä»¶"
          buildozer init
        fi
        
        # æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        echo "ğŸ“‹ Buildozeré…ç½®ä¿¡æ¯:"
        head -20 buildozer.spec
        
    - name: ğŸ”¨ æ„å»ºAndroid APK
      run: |
        echo "ğŸš€ å¼€å§‹æ„å»ºAndroid APK..."
        echo "â³ è¿™å¯èƒ½éœ€è¦20-40åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…..."
        
        # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
        export ANDROID_HOME=$HOME/Android/Sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        
        # å¼€å§‹æ„å»º
        buildozer android debug
        
    - name: ğŸ“Š æ˜¾ç¤ºæ„å»ºç»“æœ
      run: |
        echo "ğŸ“¦ æ„å»ºå®Œæˆï¼"
        if [ -d "bin" ]; then
          echo "ğŸ“± ç”Ÿæˆçš„APKæ–‡ä»¶:"
          ls -la bin/*.apk || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
          
          # æ˜¾ç¤ºAPKä¿¡æ¯
          for apk in bin/*.apk; do
            if [ -f "$apk" ]; then
              echo "ğŸ“ $apk å¤§å°: $(du -h "$apk" | cut -f1)"
            fi
          done
        else
          echo "âŒ binç›®å½•ä¸å­˜åœ¨"
        fi
        
    - name: ğŸ“¤ ä¸Šä¼ APKæ–‡ä»¶
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: ğŸ“ åˆ›å»ºå‘å¸ƒä¿¡æ¯
      if: success()
      run: |
        echo "ğŸ‰ Androidåº”ç”¨æ„å»ºæˆåŠŸï¼" > release_info.txt
        echo "" >> release_info.txt
        echo "ğŸ“± æ„å»ºä¿¡æ¯:" >> release_info.txt
        echo "- æ„å»ºæ—¶é—´: $(date)" >> release_info.txt
        echo "- æ„å»ºåˆ†æ”¯: ${GITHUB_REF#refs/heads/}" >> release_info.txt
        echo "- æäº¤å“ˆå¸Œ: ${GITHUB_SHA:0:7}" >> release_info.txt
        echo "" >> release_info.txt
        echo "ğŸ“¥ ä¸‹è½½è¯´æ˜:" >> release_info.txt
        echo "1. ç‚¹å‡»ä¸Šæ–¹çš„ 'Artifacts' ä¸‹è½½APKæ–‡ä»¶" >> release_info.txt
        echo "2. å°†APKä¼ è¾“åˆ°Androidè®¾å¤‡" >> release_info.txt
        echo "3. å…è®¸'æœªçŸ¥æ¥æº'å®‰è£…å¹¶ç‚¹å‡»APKå®‰è£…" >> release_info.txt
        echo "4. é¦–æ¬¡è¿è¡Œæ—¶æˆæƒæ‰€éœ€æƒé™" >> release_info.txt
        
    - name: ğŸ“¤ ä¸Šä¼ å‘å¸ƒä¿¡æ¯
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: release-info
        path: release_info.txt
        retention-days: 30

  # å¯é€‰: è‡ªåŠ¨å‘å¸ƒåˆ°Release
  release:
    needs: build-android
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ ä¸‹è½½APKæ–‡ä»¶
      uses: actions/download-artifact@v3
      with:
        name: android-apk
        path: apk/
        
    - name: ğŸ·ï¸ åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: "äº¤æ˜“è·Ÿå•æœºå™¨äºº v${{ github.run_number }}"
        body: |
          ğŸ¤– **Androidäº¤æ˜“è·Ÿå•æœºå™¨äºº**
          
          ğŸ“± **å®‰è£…è¯´æ˜:**
          1. ä¸‹è½½ä¸‹æ–¹çš„APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå…è®¸"æœªçŸ¥æ¥æº"å®‰è£…
          3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          4. é¦–æ¬¡è¿è¡Œæ—¶æˆæƒæ‰€éœ€æƒé™
          5. é…ç½®APIå¯†é’¥åå³å¯å¼€å§‹ä½¿ç”¨
          
          âš ï¸ **æ³¨æ„äº‹é¡¹:**
          - ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨
          - è¯·åœ¨å……åˆ†äº†è§£é£é™©åä½¿ç”¨
          - å»ºè®®å…ˆç”¨å°é¢èµ„é‡‘æµ‹è¯•
          
          ğŸ”„ **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
        files: apk/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
